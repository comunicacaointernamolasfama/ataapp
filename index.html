<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtaApp Admin Panel v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); z-index: 40;
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.open { opacity: 1; }
        
        .modal-content {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50;
            opacity: 0; transform: translate(-50%, -40%); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .modal-content.open { opacity: 1; transform: translate(-50%, -50%); }

        .accordion-content {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 1000px;
        }
        .rotate-180 { transform: rotate(180deg); }
        .input-style {
            width: 100%; padding: 0.5rem 0.75rem; background-color: #374151;
            border: 1px solid #4B5563; border-radius: 0.375rem; outline: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="app-container" class="min-h-screen p-4 md:p-8">

        <!-- ===== LOGIN VIEW ===== -->
        <div id="login-view" class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-lg border border-gray-700">
                <h1 class="text-3xl text-center font-bold text-cyan-400 mb-8">AtaApp Admin</h1>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="email" placeholder="Email" class="input-style" required>
                    <input type="password" id="password" placeholder="Senha" class="input-style" required>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
                    <p id="login-error" class="text-red-400 text-sm mt-2 text-center h-5"></p>
                </form>
            </div>
        </div>

        <!-- ===== DASHBOARD VIEW (Hidden by default) ===== -->
        <div id="dashboard-view" class="hidden w-full max-w-screen-2xl mx-auto">
            <header class="flex justify-between items-center mb-8 p-4 bg-gray-800 rounded-lg border border-gray-700">
                <h1 class="text-2xl font-bold text-cyan-400">Dashboard AtaApp</h1>
                <div>
                    <span id="user-email" class="text-gray-400 mr-4"></span>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md text-sm transition duration-300">Sair</button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Coluna da Esquerda: Lista de Clientes (Acordeão) -->
                <section class="lg:col-span-2 bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4">Clientes e Usuários</h2>
                    <div id="clients-list" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2"></div>
                </section>

                <!-- Coluna da Direita: Formulários -->
                <section class="flex flex-col gap-8">
                    <!-- Gerenciar Clientes -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Clientes</h2>
                        <form id="add-client-form" class="space-y-3">
                            <input type="text" id="company-name" placeholder="Nome da Empresa" class="input-style" required>
                            <input type="url" id="logo-url" placeholder="URL da Logo" class="input-style">
                            <div class="flex items-center gap-4"><label class="text-sm">Cor Primária:</label><input type="color" id="primary-color" value="#4A90E2" class="bg-gray-700 rounded"></div>
                            <input type="text" id="gamma-theme-name" placeholder="Nome do Tema na Gamma" class="input-style" required>
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-cyan-600 hover:bg-cyan-700">Salvar Cliente</button>
                        </form>
                    </div>
                    <!-- Gerenciar Usuários -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Usuários</h2>
                        <form id="add-user-form" class="space-y-3">
                            <select id="user-client-select" class="input-style" required><option value="">Selecione um Cliente...</option></select>
                            <input type="text" id="user-telegram-id" placeholder="ID do Telegram do Usuário" class="input-style" required>
                            <input type="text" id="user-name" placeholder="Nome (Opcional)" class="input-style">
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-green-600 hover:bg-green-700">Adicionar Usuário</button>
                        </form>
                    </div>
                    <!-- Gerenciar Vozes -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Vozes</h2>
                         <div id="voices-tabs" class="flex border-b border-gray-600 mb-4">
                            <button class="tab-button py-2 px-4 text-gray-400 border-b-2 border-transparent" data-tab="standard">Padrão</button>
                            <button class="tab-button py-2 px-4 text-gray-400 border-b-2 border-transparent" data-tab="custom">Premium</button>
                         </div>
                         <div id="standard-voices-tab">
                            <div id="standard-voices-list" class="mb-4 text-sm text-gray-400 space-y-1"></div>
                            <form id="add-standard-voice-form" class="space-y-3">
                                <input type="text" id="std-voice-name" placeholder="Nome da Voz" class="input-style" required>
                                <input type="text" id="std-voice-id" placeholder="ID da Voz (ElevenLabs)" class="input-style" required>
                                <input type="number" id="std-display-order" placeholder="Ordem de Exibição (1, 2, ...)" class="input-style" required>
                                <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-purple-600 hover:bg-purple-700">Adicionar Voz Padrão</button>
                            </form>
                         </div>
                         <div id="custom-voices-tab" class="hidden">
                             <form id="add-custom-voice-form" class="space-y-3">
                                <select id="custom-voice-client-select" class="input-style" required><option value="">Selecione um Cliente...</option></select>
                                <input type="text" id="custom-voice-name" placeholder="Nome da Voz" class="input-style" required>
                                <input type="text" id="custom-voice-id" placeholder="ID da Voz Clonada" class="input-style" required>
                                <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-yellow-600 hover:bg-yellow-700">Adicionar Voz Premium</button>
                            </form>
                         </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- Modal para Editar Cliente -->
    <div id="edit-client-modal" class="hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content bg-gray-800 p-6 rounded-lg w-full max-w-md border border-gray-600">
            <h2 class="text-xl font-semibold mb-4">Editar Cliente</h2>
            <form id="edit-client-form" class="space-y-3">
                <input type="hidden" id="edit-client-id">
                <input type="text" id="edit-company-name" placeholder="Nome da Empresa" class="input-style" required>
                <input type="url" id="edit-logo-url" placeholder="URL da Logo" class="input-style">
                <div class="flex items-center gap-4"><label class="text-sm">Cor Primária:</label><input type="color" id="edit-primary-color" class="bg-gray-700 rounded"></div>
                <input type="text" id="edit-gamma-theme-name" placeholder="Nome do Tema na Gamma" class="input-style" required>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="cancel-button px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded transition">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast" class="toast"></div>

    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://pdqkvyxufnprapkgsvxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkcWt2eXh1Zm5wcmFwa2dzdnh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE2MzAsImV4cCI6MjA3ODc3NzYzMH0.CFxmP1S8829joB6txKQ4bypp-Qr7SDHAg0P2Dgpti1k';

        // ===== INITIALIZATION =====
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== GLOBAL STATE =====
        let allData = {};

        // ===== DOM REFERENCES =====
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const userEmailSpan = document.getElementById('user-email');
        const toastElement = document.getElementById('toast');
        const clientsListDiv = document.getElementById('clients-list');
        const standardVoicesListDiv = document.getElementById('standard-voices-list');
        const userClientSelect = document.getElementById('user-client-select');
        const customVoiceClientSelect = document.getElementById('custom-voice-client-select');
        const editClientModal = document.getElementById('edit-client-modal');
        const tabsContainer = document.getElementById('voices-tabs');
        const standardVoicesTab = document.getElementById('standard-voices-tab');
        const customVoicesTab = document.getElementById('custom-voices-tab');

        // ===== UTILITY FUNCTIONS =====
        const showToast = (message, type = 'success') => {
            toastElement.textContent = message;
            toastElement.className = `toast show ${type}`;
            setTimeout(() => { toastElement.className = 'toast'; }, 3000);
        };
        
        const openModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.querySelector('.modal-overlay').classList.add('open');
                modalElement.querySelector('.modal-content').classList.add('open');
            }, 10);
        };

        const closeModal = (modalElement) => {
            modalElement.querySelector('.modal-overlay').classList.remove('open');
            modalElement.querySelector('.modal-content').classList.remove('open');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 200);
        };

        // ===== CORE LOGIC =====
        const checkUserSession = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                userEmailSpan.textContent = session.user.email;
                await loadDashboardData();
            } else {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            }
        };

        const loadDashboardData = async () => {
            clientsListDiv.innerHTML = `<p class="text-gray-500">Carregando...</p>`;
            
            const [clientsRes, usersRes, stdVoicesRes, customVoicesRes] = await Promise.all([
                supabaseClient.from('clients').select('*').order('company_name'),
                supabaseClient.from('authorized_users').select('*'),
                supabaseClient.from('standard_voices').select('*').order('display_order'),
                supabaseClient.from('custom_voices').select('*')
            ]);

            allData = {
                clients: clientsRes.data || [],
                users: usersRes.data || [],
                stdVoices: stdVoicesRes.data || [],
                customVoices: customVoicesRes.data || [],
            };
            
            const hasError = clientsRes.error || usersRes.error || stdVoicesRes.error || customVoicesRes.error;
            if (hasError) {
                showToast('Erro ao carregar dados do painel.', 'error');
                console.error(hasError);
                return;
            }

            renderDashboard();
            populateClientSelects();
        };

        const populateClientSelects = () => {
            const selects = [userClientSelect, customVoiceClientSelect];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um Cliente...</option>';
                allData.clients.forEach(client => {
                    select.innerHTML += `<option value="${client.id}">${client.company_name}</option>`;
                });
            });
        };

        const renderDashboard = () => {
            standardVoicesListDiv.innerHTML = allData.stdVoices.length > 0
                ? allData.stdVoices.map(v => `<div class="flex justify-between items-center"><span>${v.display_order}. ${v.voice_name}</span><button class="delete-btn text-red-500" data-id="${v.id}" data-table="standard_voices">✖</button></div>`).join('')
                : '<p>Nenhuma voz padrão cadastrada.</p>';

            if (allData.clients.length === 0) {
                clientsListDiv.innerHTML = '<p class="text-gray-500">Nenhum cliente cadastrado.</p>';
                return;
            }

            clientsListDiv.innerHTML = allData.clients.map(client => {
                const clientUsers = allData.users.filter(u => u.client_id === client.id);
                const clientCustomVoices = allData.customVoices.filter(v => v.client_id === client.id);

                const usersHtml = clientUsers.length > 0
                    ? clientUsers.map(u => `<li class="flex justify-between items-center">${u.user_name || 'Usuário sem nome'} - ID: ${u.user_telegram_id}<button class="delete-btn text-red-500 ml-2" data-id="${u.id}" data-table="authorized_users">✖</button></li>`).join('')
                    : '<li class="text-gray-500">Nenhum usuário</li>';

                const voicesHtml = clientCustomVoices.length > 0
                    ? clientCustomVoices.map(v => `<li class="flex justify-between items-center">${v.voice_name}<button class="delete-btn text-red-500 ml-2" data-id="${v.id}" data-table="custom_voices">✖</button></li>`).join('')
                    : '<li class="text-gray-500">Nenhuma voz premium</li>';

                return `
                <div class="bg-gray-700 rounded-lg border border-gray-600">
                    <div class="accordion-header flex justify-between items-center p-4 cursor-pointer">
                        <div class="flex items-center gap-4">
                            <img src="${client.logo_url || 'https://via.placeholder.com/40/374151/FFFFFF?text=L'}" alt="${client.company_name}" class="w-10 h-10 rounded-full object-cover bg-white">
                            <h3 class="text-lg font-bold">${client.company_name}</h3>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="edit-client-btn text-blue-400 hover:text-blue-300 text-sm" data-id="${client.id}">Editar</button>
                            <button class="delete-btn text-red-500 hover:text-red-400 text-sm" data-id="${client.id}" data-table="clients">Excluir</button>
                            <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="accordion-content px-4 pb-4 text-sm text-gray-400">
                        <div class="border-t border-gray-600 pt-4 space-y-4">
                            <div><strong>Tema Gamma:</strong> ${client.gamma_theme_name}</div>
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-2">Usuários Autorizados:</h4>
                                <ul class="space-y-1">${usersHtml}</ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-2">Vozes Premium:</h4>
                                <ul class="space-y-1">${voicesHtml}</ul>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };
        
        const handleDelete = async (id, tableName) => {
            if (!confirm(`Tem certeza que deseja excluir este item? A ação não pode ser desfeita.`)) return;
            
            const { error } = await supabaseClient.from(tableName).delete().eq('id', id);
            
            if (error) { showToast(`Erro ao excluir item.`, 'error'); console.error(error); }
            else { showToast('Item excluído com sucesso!'); await loadDashboardData(); }
        };

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            checkUserSession();

            // Event Delegation for dynamic buttons
            document.body.addEventListener('click', (e) => {
                const accordionHeader = e.target.closest('.accordion-header');
                if (accordionHeader && !e.target.closest('button')) {
                    const content = accordionHeader.nextElementSibling;
                    content.classList.toggle('open');
                    accordionHeader.querySelector('svg').classList.toggle('rotate-180');
                    return;
                }
                
                if (e.target.matches('.edit-client-btn')) {
                    const clientId = e.target.dataset.id;
                    const client = allData.clients.find(c => c.id === clientId);
                    if (client) {
                        document.getElementById('edit-client-id').value = client.id;
                        document.getElementById('edit-company-name').value = client.company_name;
                        document.getElementById('edit-logo-url').value = client.logo_url;
                        document.getElementById('edit-primary-color').value = client.primary_color_hex;
                        document.getElementById('edit-gamma-theme-name').value = client.gamma_theme_name;
                        openModal(editClientModal);
                    }
                    return;
                }
                
                if (e.target.matches('.delete-btn')) {
                    const id = e.target.dataset.id;
                    const table = e.target.dataset.table;
                    handleDelete(id, table);
                    return;
                }
            });
            
            // Tab switching for voices
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tab = e.target.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('text-white', 'border-cyan-400'));
                    e.target.classList.add('text-white', 'border-cyan-400');
                    
                    if (tab === 'standard') {
                        standardVoicesTab.classList.remove('hidden');
                        customVoicesTab.classList.add('hidden');
                    } else {
                        standardVoicesTab.classList.add('hidden');
                        customVoicesTab.classList.remove('hidden');
                    }
                }
            });
            // Initial active tab
            tabsContainer.querySelector('[data-tab="standard"]').classList.add('text-white', 'border-cyan-400');

            // Close modal
            editClientModal.querySelector('.cancel-button').addEventListener('click', () => closeModal(editClientModal));
            
            // Form Submissions
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) { loginError.textContent = 'Credenciais inválidas.'; } 
                else { await checkUserSession(); }
            });

            document.getElementById('logout-button').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                await checkUserSession();
            });
            
            document.getElementById('edit-client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-client-id').value;
                const updatedData = {
                    company_name: document.getElementById('edit-company-name').value,
                    logo_url: document.getElementById('edit-logo-url').value || null,
                    primary_color_hex: document.getElementById('edit-primary-color').value,
                    gamma_theme_name: document.getElementById('edit-gamma-theme-name').value,
                };
                const { error } = await supabaseClient.from('clients').update(updatedData).eq('id', id);
                if (error) { showToast('Erro ao atualizar cliente.', 'error'); }
                else {
                    showToast('Cliente atualizado!');
                    closeModal(editClientModal);
                    await loadDashboardData();
                }
            });

            const setupForm = (formId, tableName, successMsg) => {
                document.getElementById(formId).addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    const record = {};
                    formData.forEach((value, key) => { record[form.querySelector(`[id="${key}"]`).id] = value || null; });
                    
                    // Manually map form field IDs to DB column names
                    let dbRecord = {};
                    if(tableName === 'clients') dbRecord = { company_name: record['company-name'], logo_url: record['logo-url'], primary_color_hex: record['primary-color'], gamma_theme_name: record['gamma-theme-name'] };
                    if(tableName === 'authorized_users') dbRecord = { client_id: record['user-client-select'], user_telegram_id: record['user-telegram-id'], user_name: record['user-name'] };
                    if(tableName === 'standard_voices') dbRecord = { voice_name: record['std-voice-name'], voice_id: record['std-voice-id'], display_order: record['std-display-order'] };
                    if(tableName === 'custom_voices') dbRecord = { client_id: record['custom-voice-client-select'], voice_name: record['custom-voice-name'], voice_id: record['custom-voice-id'] };

                    const { error } = await supabaseClient.from(tableName).insert([dbRecord]);
                    if(error) { showToast(`Erro ao salvar.`, 'error'); console.error(error); }
                    else { showToast(successMsg); form.reset(); await loadDashboardData(); }
                });
            };
            
            setupForm('add-client-form', 'clients', 'Cliente salvo!');
            setupForm('add-user-form', 'authorized_users', 'Usuário salvo!');
            setupForm('add-standard-voice-form', 'standard_voices', 'Voz padrão salva!');
            setupForm('add-custom-voice-form', 'custom_voices', 'Voz premium salva!');
        });
    </script>
</body>
</html>
