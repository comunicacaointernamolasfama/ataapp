<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtaApp Admin Panel v2.1</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .input-style {
            width: 100%; padding: 0.5rem 0.75rem; background-color: #374151;
            border: 1px solid #4B5563; border-radius: 0.375rem;
            outline: none;
        }
        .input-style:focus {
            ring: 2px; ring-color: #06B6D4;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- ===== LOGIN VIEW ===== -->
        <div id="login-view">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-lg border border-gray-700">
                <h1 class="text-3xl text-center font-bold text-cyan-400 mb-8">AtaApp Admin</h1>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="email" placeholder="Email" class="input-style" required>
                    <input type="password" id="password" placeholder="Senha" class="input-style" required>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
                    <p id="login-error" class="text-red-400 text-sm mt-2 text-center h-5"></p>
                </form>
            </div>
        </div>

        <!-- ===== DASHBOARD VIEW (Hidden by default) ===== -->
        <div id="dashboard-view" class="hidden w-full max-w-screen-xl">
            <header class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                <h1 class="text-2xl font-bold text-cyan-400">Dashboard AtaApp</h1>
                <div>
                    <span id="user-email" class="text-gray-400 mr-4"></span>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md text-sm transition duration-300">Sair</button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Coluna 1: Clientes e Usuários -->
                <section class="xl:col-span-2 flex flex-col gap-6">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Clientes e Usuários</h2>
                        <div id="clients-list" class="space-y-6 max-h-[80vh] overflow-y-auto pr-2"></div>
                    </div>
                </section>

                <!-- Coluna 2: Formulários de Ação -->
                <section class="flex flex-col gap-6">
                    <!-- Gerenciar Clientes -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Clientes</h2>
                        <form id="add-client-form" class="space-y-3">
                            <input type="text" id="company-name" placeholder="Nome da Empresa" class="input-style" required>
                            <input type="url" id="logo-url" placeholder="URL da Logo" class="input-style">
                            <div class="flex items-center gap-4"><label class="text-sm">Cor Primária:</label><input type="color" id="primary-color" value="#4A90E2" class="bg-gray-700"></div>
                            <input type="text" id="gamma-theme-name" placeholder="Nome do Tema na Gamma" class="input-style" required>
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-cyan-600 hover:bg-cyan-700">Salvar Cliente</button>
                        </form>
                    </div>
                    <!-- Gerenciar Usuários Autorizados -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Usuários</h2>
                        <form id="add-user-form" class="space-y-3">
                            <select id="user-client-select" class="input-style" required><option value="">Selecione um Cliente...</option></select>
                            <input type="text" id="user-telegram-id" placeholder="ID do Telegram do Usuário" class="input-style" required>
                            <input type="text" id="user-name" placeholder="Nome (Opcional)" class="input-style">
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-green-600 hover:bg-green-700">Adicionar Usuário</button>
                        </form>
                    </div>
                     <!-- Gerenciar Vozes Padrão -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Gerenciar Vozes Padrão</h2>
                         <div id="standard-voices-list" class="mb-4 text-sm text-gray-400 space-y-1"></div>
                        <form id="add-standard-voice-form" class="space-y-3">
                            <input type="text" id="std-voice-name" placeholder="Nome da Voz (Ex: Narrador Calmo)" class="input-style" required>
                            <input type="text" id="std-voice-id" placeholder="ID da Voz (ElevenLabs)" class="input-style" required>
                            <input type="number" id="std-display-order" placeholder="Ordem de Exibição (1, 2, ...)" class="input-style" required>
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-purple-600 hover:bg-purple-700">Adicionar Voz Padrão</button>
                        </form>
                    </div>
                    <!-- Gerenciar Vozes Customizadas -->
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Vozes Personalizadas (Premium)</h2>
                        <form id="add-custom-voice-form" class="space-y-3">
                            <select id="custom-voice-client-select" class="input-style" required><option value="">Selecione um Cliente...</option></select>
                            <input type="text" id="custom-voice-name" placeholder="Nome da Voz (Ex: Voz do Diretor)" class="input-style" required>
                            <input type="text" id="custom-voice-id" placeholder="ID da Voz Clonada (ElevenLabs)" class="input-style" required>
                            <button type="submit" class="w-full text-white font-bold py-2 px-4 rounded-md transition duration-300 bg-yellow-600 hover:bg-yellow-700">Adicionar Voz Premium</button>
                        </form>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast" class="toast"></div>

    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://pdqkvyxufnprapkgsvxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzIΙNiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkcWt2eXh1Zm5wcmFwa2dzdnh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE2MzAsImV4cCI6MjA3ODc3NzYzMH0.CFxmP1S8829joB6txKQ4bypp-Qr7SDHAg0P2Dgpti1k';

        // ===== INITIALIZATION =====
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== DOM REFERENCES =====
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const userEmailSpan = document.getElementById('user-email');
        const toastElement = document.getElementById('toast');
        const clientsListDiv = document.getElementById('clients-list');
        const standardVoicesListDiv = document.getElementById('standard-voices-list');
        const userClientSelect = document.getElementById('user-client-select');
        const customVoiceClientSelect = document.getElementById('custom-voice-client-select');

        // ===== UTILITY FUNCTIONS =====
        const showToast = (message, type = 'success') => {
            toastElement.textContent = message;
            toastElement.className = `toast show ${type}`;
            setTimeout(() => { toastElement.className = 'toast'; }, 3000);
        };

        // ===== CORE LOGIC =====
        const checkUserSession = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                userEmailSpan.textContent = session.user.email;
                await loadDashboardData();
            } else {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            }
        };

        const loadDashboardData = async () => {
            clientsListDiv.innerHTML = `<p class="text-gray-500">Carregando...</p>`;
            
            const [clientsRes, usersRes, stdVoicesRes, customVoicesRes] = await Promise.all([
                supabaseClient.from('clients').select('*').order('company_name'),
                supabaseClient.from('authorized_users').select('*'),
                supabaseClient.from('standard_voices').select('*').order('display_order'),
                supabaseClient.from('custom_voices').select('*')
            ]);

            const { data: clients, error: clientsError } = clientsRes;
            const { data: users, error: usersError } = usersRes;
            const { data: stdVoices, error: stdVoicesError } = stdVoicesRes;
            const { data: customVoices, error: customVoicesError } = customVoicesRes;
            
            if (clientsError || usersError || stdVoicesError || customVoicesError) {
                const errorMsg = 'Erro ao carregar dados do painel.';
                showToast(errorMsg, 'error');
                console.error(clientsError || usersError || stdVoicesError || customVoicesError);
                clientsListDiv.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                return;
            }

            renderDashboard(clients, users, stdVoices, customVoices);
            populateClientSelects(clients);
        };

        const populateClientSelects = (clients) => {
            const selects = [userClientSelect, customVoiceClientSelect];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um Cliente...</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.company_name;
                    select.appendChild(option);
                });
            });
        };

        const renderDashboard = (clients, users, stdVoices, customVoices) => {
            standardVoicesListDiv.innerHTML = stdVoices.length > 0
                ? stdVoices.map(v => `<div>${v.display_order}. ${v.voice_name}</div>`).join('')
                : '<p>Nenhuma voz padrão cadastrada.</p>';

            if (clients.length === 0) {
                clientsListDiv.innerHTML = '<p class="text-gray-500">Nenhum cliente cadastrado.</p>';
                return;
            }

            clientsListDiv.innerHTML = clients.map(client => {
                const clientUsers = users.filter(user => user.client_id === client.id);
                const clientCustomVoices = customVoices.filter(voice => voice.client_id === client.id);

                const usersHtml = clientUsers.length > 0
                    ? clientUsers.map(u => `<li>${u.user_name || 'Usuário sem nome'} - ID: ${u.user_telegram_id}</li>`).join('')
                    : '<li class="text-gray-500">Nenhum usuário</li>';

                const voicesHtml = clientCustomVoices.length > 0
                    ? clientCustomVoices.map(v => `<li>${v.voice_name}</li>`).join('')
                    : '<li class="text-gray-500">Nenhuma voz premium</li>';

                return `
                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <div class="flex items-center gap-3 mb-3">
                            ${client.logo_url ? `<img src="${client.logo_url}" class="w-10 h-10 rounded-full object-cover bg-white">` : `<div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center text-lg font-bold">${client.company_name.charAt(0)}</div>`}
                            <h3 class="text-lg font-bold">${client.company_name}</h3>
                        </div>
                        <div class="text-sm text-gray-400 space-y-3 pl-2 border-l-2 border-gray-500 ml-4">
                            <div><strong>Tema Gamma:</strong> ${client.gamma_theme_name}</div>
                            <div>
                                <h4 class="font-semibold text-gray-300">Usuários Autorizados:</h4>
                                <ul class="list-disc list-inside">${usersHtml}</ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-300">Vozes Premium:</h4>
                                <ul class="list-disc list-inside">${voicesHtml}</ul>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // ===== EVENT LISTENERS =====
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            
            if (error) {
                loginError.textContent = 'Credenciais inválidas.';
                console.error('Login Error:', error.message);
            } else {
                await checkUserSession();
            }
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            await checkUserSession();
        });
        
        document.getElementById('add-client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const record = {
                company_name: document.getElementById('company-name').value,
                logo_url: document.getElementById('logo-url').value || null,
                primary_color_hex: document.getElementById('primary-color').value,
                gamma_theme_name: document.getElementById('gamma-theme-name').value,
            };
            const { error } = await supabaseClient.from('clients').insert([record]);
            if(error) { showToast('Erro ao salvar cliente', 'error'); console.error(error); }
            else { showToast('Cliente salvo!'); e.target.reset(); await loadDashboardData(); }
        });
        
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const record = {
                client_id: document.getElementById('user-client-select').value,
                user_telegram_id: document.getElementById('user-telegram-id').value,
                user_name: document.getElementById('user-name').value || null,
            };
            const { error } = await supabaseClient.from('authorized_users').insert([record]);
            if(error) { showToast('Erro ao salvar usuário', 'error'); console.error(error); }
            else { showToast('Usuário salvo!'); e.target.reset(); await loadDashboardData(); }
        });

        document.getElementById('add-standard-voice-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const record = {
                voice_name: document.getElementById('std-voice-name').value,
                voice_id: document.getElementById('std-voice-id').value,
                display_order: document.getElementById('std-display-order').value,
            };
            const { error } = await supabaseClient.from('standard_voices').insert([record]);
            if(error) { showToast('Erro ao salvar voz padrão', 'error'); console.error(error); }
            else { showToast('Voz padrão salva!'); e.target.reset(); await loadDashboardData(); }
        });

        document.getElementById('add-custom-voice-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const record = {
                client_id: document.getElementById('custom-voice-client-select').value,
                voice_name: document.getElementById('custom-voice-name').value,
                voice_id: document.getElementById('custom-voice-id').value,
            };
            const { error } = await supabaseClient.from('custom_voices').insert([record]);
            if(error) { showToast('Erro ao salvar voz premium', 'error'); console.error(error); }
            else { showToast('Voz premium salva!'); e.target.reset(); await loadDashboardData(); }
        });

        // ===== INITIAL LOAD =====
        document.addEventListener('DOMContentLoaded', checkUserSession);
    </script>
</body>
</html>
